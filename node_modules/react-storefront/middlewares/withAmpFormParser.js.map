{"version":3,"sources":["../../src/middlewares/withAmpFormParser.js"],"names":["withAmpFormParser","handler","req","res","form","method","toLowerCase","parse","err","fields","files","status","end","message","body"],"mappings":";;;;;;;;;AAAA;;AAEA;;;;;;;;;;;;;;;;;;;AAmBe,SAASA,iBAAT,CAA2BC,OAA3B,EAAoC;AACjD,SAAO,UAACC,GAAD,EAAMC,GAAN,EAAc;AACnB,QAAMC,IAAI,GAAG,6BAAb;;AAEA,QAAIF,GAAG,CAACG,MAAJ,CAAWC,WAAX,OAA6B,MAAjC,EAAyC;AACvC,UAAI;AACFF,QAAAA,IAAI,CAACG,KAAL,CAAWL,GAAX,EAAgB,UAACM,GAAD,EAAMC,MAAN,EAAcC,KAAd,EAAwB;AACtC,cAAIF,GAAJ,EAAS;AACPL,YAAAA,GAAG,CAACQ,MAAJ,CAAW,GAAX,EAAgBC,GAAhB,CAAoBJ,GAAG,CAACK,OAAxB;AACD,WAFD,MAEO;AACLX,YAAAA,GAAG,CAACY,IAAJ,GAAWL,MAAX;AACA,mBAAOR,OAAO,CAACC,GAAD,EAAMC,GAAN,CAAd;AACD;AACF,SAPD;AAQD,OATD,CASE,OAAOK,GAAP,EAAY;AACZ;AACAL,QAAAA,GAAG,CAACQ,MAAJ,CAAW,GAAX,EAAgBC,GAAhB,CAAoBJ,GAAG,CAACK,OAAxB;AACD;AACF,KAdD,MAcO;AACL,aAAOZ,OAAO,CAACC,GAAD,EAAMC,GAAN,CAAd;AACD;AACF,GApBD;AAqBD","sourcesContent":["import formidable from 'formidable'\n\n/**\n * Wraps the provided handler in a middleware that parses AMP form submissions correctly.  By\n * default, next.js's body parser doesn't handle multipart form posts properly, so you\n * won't be able to receive data posted from a form in AMP.\n *\n * When using this middleware, you should always disable next's default body parser by adding\n * the following to your api endpoint:\n *\n * ```js\n * export const config = {\n *   api: {\n *     bodyParser: false\n *   }\n * }\n * ```\n *\n * @param {Function} handler An API endpoint\n * @return {Function} Your API function with body parsing middleware added.\n */\nexport default function withAmpFormParser(handler) {\n  return (req, res) => {\n    const form = formidable()\n\n    if (req.method.toLowerCase() === 'post') {\n      try {\n        form.parse(req, (err, fields, files) => {\n          if (err) {\n            res.status(500).end(err.message)\n          } else {\n            req.body = fields\n            return handler(req, res)\n          }\n        })\n      } catch (err) {\n        /* istanbul ignore next */\n        res.status(500).end(err.message)\n      }\n    } else {\n      return handler(req, res)\n    }\n  }\n}\n"],"file":"withAmpFormParser.js"}